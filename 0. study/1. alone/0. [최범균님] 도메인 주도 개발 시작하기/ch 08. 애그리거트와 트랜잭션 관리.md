# 8. 애그리거트와 트랜잭션 관리

## 8.1 애그리거트와 트랜잭션

- 애그리거트의 일관성이 깨지는 문제가 발생
  - 운영자가 배송 상태로 변경하는 동안
  - 고객은 배송지 정보를 변경

- 해결법
  - 운영자가 상태를 변경하는 동안 고객이 애그리거트 수정을 못하게 한다
    - 선점 잠금: 비관적 락
  - 운영자가 정보 조회 후 고객이 정보를 변경했다면 운영자가 애그리거트를 다시 조회 후 수정하도록 함

## 8.2 선점 잠금

- 운영자가 상태를 변경하는 동안 고객이 애그리거트 수정을 못하게 한다
- 비관적 락 이용
  - select for update
  - 행 단위 잠금
  - 특정 레코드에 한 커넥션만 접근

### 8.2.1 선점 잠금과 교착 상태

- 데드락을 조심해야 한다!

- 데드락 발생 시나리오
  - Thread1: A Aggr에 대한 선점 잠금을 가지고 있음
  - Thread2: B Aggr에 대한 선점 잠금을 가지고 있음

  - Thread1: B Aggr에 대한 선점 잠금 시도
  - Thread2: A Aggr에 대한 선점 잠금 시도

- 데드락 해결법
  
  - Hibernate

  - ```java
    Map<String, Object> map = new HashMap<>();
    map.put("javax.persistence.lock.timeout", 2_000);
    entityManager.find(엔티티.class, 엔티티_ID, LockModeType.PESSIMISTIC_WRITE, map);
    ```

  - Spring JPA

  - ```java
  @Lock(LockModeType.PESSIMISTIC_WRITE)
  @QueryHints({
    @QueryHint(name = "javax.persistence.lock.timeout", value = "2_000")
  })
  @Query("쿼리")
    ```

### 8.3 비선점 잠금

-